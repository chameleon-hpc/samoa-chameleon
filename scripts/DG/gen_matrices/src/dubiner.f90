MODULE dubiner
  use lu

  real(kind=GRID_SR),dimension(:,:),Allocatable :: v_inv
  
contains
  function jacobiPolynomial(x,N,a,b) result(y)
    real(kind=GRID_SR),intent(in) :: x
    real(kind=GRID_SR)            :: y
    integer                       :: N,a,b,m,a2_b2
    real(kind=GRID_SR)                       :: p_old2,p_old1, p

    if(n.eq.0) then
       y=1.0_GRID_SR
       return
    end if
    a2_b2=a*a-b*b

    p= 0.5_GRID_SR*a - 0.5_GRID_SR*b + (1.0_GRID_SR+0.5_GRID_SR*(a+b)) * x
!    print*,p
    p_old1=1.0
    do m=2,N
       p_old2=p_old1
       p_old1=p
       p= ((2.0_GRID_SR*m+a+b-1.0_GRID_SR)*(a2_b2 + (2.0_GRID_SR*m+a+b)*(2.0_GRID_SR*m+a+b-2.0_GRID_SR)*x)*p_old1 - 2.0_GRID_SR*(m+a-1.0_GRID_SR)*(m+b-1.0_GRID_SR)*(2.0_GRID_SR*m+a+b)*p_old2 ) / Real(2.0_GRID_SR*m*(m+a+b)*(2.0_GRID_SR*m+a+b-2.0_GRID_SR),GRID_SR)
    end do
    y=p
    return
  end function jacobiPolynomial

  function jacobiFirstDerivative(x,N,a,b)  result(y)
    real(kind=GRID_SR),intent(in) :: x
    real(kind=GRID_SR)            :: y
    integer                       :: N,a,b,m
    if(N.eq.0)then
       y=0.0_GRID_SR
       return
    end if
    y= 0.5_GRID_SR*(N+a+b+1.0_GRID_SR) * jacobiPolynomial(x,N-1,a+1,b+1)
  end function jacobiFirstDerivative


  function jacobiTriangle(x,y,N,a,b)  result(z)
    real(kind=GRID_SR),intent(in) :: x,y
    real(kind=GRID_SR)            :: z
    integer                       :: N,a,b,m
    real(kind=GRID_SR)            :: r,s

    r= 2.0_GRID_SR * x / (1.0_GRID_SR-y) -1.0_GRID_SR
    s= 2.0_GRID_SR * y -1.0_GRID_SR

    z=jacobiPolynomial(r,N,a,0)*jacobiPolynomial(s,N,b,2*a+1)

  end function jacobiTriangle


  function monomial_1d(x,i)
    real(kind=GRID_SR) :: x,monomial_1d
    integer :: i
    
    monomial_1d=x**i
  end function monomial_1d

  function monomial(x,y,i,j)
    real(kind=GRID_SR) :: x,y,monomial
    integer :: i,j

    monomial=monomial_1d(x,i)*monomial_1d(y,j)

  end function monomial


  function monomial_der_x(x,y,i,j)
    real(kind=GRID_SR) :: x,y,monomial_der_x
    integer :: i,j
    if(i.eq.0)then
       monomial_der_x=0
    else if(i.eq.1) then
       monomial_der_x=monomial_1d(y,j)
    else
       monomial_der_x=Real(i,GRID_SR)*x**(i-1)*monomial_1d(y,j)
    end if
       


  end function monomial_der_x

    function monomial_der_y(x,y,i,j)
    real(kind=GRID_SR) :: x,y,monomial_der_y
    integer :: i,j
    if(j.eq.0)then
       monomial_der_y=0
    else if(j.eq.1) then
       monomial_der_y=monomial_1d(x,i)
    else
       monomial_der_y=Real(j,GRID_SR)*y**(j-1)*monomial_1d(x,i)
    end if
    
  end function monomial_der_y
  

  subroutine gen_vandermonde_inv_equidistand(N)
    integer :: N,M,i,j,k,ind,d,code
    integer :: pivot((N+1*N+2)/2)
    real(kind=GRID_SR),Allocatable :: Nodes(:,:)
    real(kind=GRID_SR),Allocatable :: v(:,:)

    print*,"*"
    M=(N+1)*(N+2)/2

!    call get_gll_nodes(Nodes,N+1)

    !--Equidistand basis--!

    allocate(Nodes(M,M))
    do j=0,N
       do i=0,N-j
          ind=(i+1)+M-((N-j+1))*((N-j+2))/2
          Nodes(1,ind) = (i)/Real(N)
          Nodes(2,ind) = (j)/Real(N)
       end do
    end do
    
    pivot=0

    allocate(v(size(Nodes,2),M))
    
    if(allocated(v_inv)) then
       deallocate(v_inv)
    end if
    
    allocate(v_inv(size(Nodes,2),M))
    
    do j=0,N
       do i=0,N-j
          do k=1,size(Nodes,2)
             ind=(1+i)+M-((N-j+1))*((N-j+2))/2
             v(k,ind)=monomial(Nodes(1,k),Nodes(2,k),i,j)
!             v(k,ind)=jacobiTriangle(Nodes(1,k),Nodes(2,k),N,i,j)
          end do
       end do
    end do
    call ludcmp(v,M,pivot,d,code)

    do i=1,M
       v_inv(:,i)=0
       v_inv(i,i)=1
    end do

    do i=1,M
       call lubksb(v,M,pivot,v_inv(:,i))
    end do

  end subroutine gen_vandermonde_inv_equidistand
  


  subroutine gen_vandermonde_inv_lgl(N)
    integer :: N,M,i,j,k,ind,d,code
    integer :: pivot((N+1*N+2)/2)
    real(kind=GRID_SR),Allocatable :: Nodes(:,:)
    real(kind=GRID_SR),Allocatable :: v(:,:)

    M=(N+1)*(N+2)/2

    call get_lgl_nodes(Nodes,N+1)
    
    pivot=0

    allocate(v(size(Nodes,2),M))
    
    if(allocated(v_inv)) then
       deallocate(v_inv)
    end if
    
    allocate(v_inv(size(Nodes,2),M))
    
    do j=0,N
       do i=0,N-j
          do k=1,size(Nodes,2)
             ind=(1+i)+M-((N-j+1))*((N-j+2))/2
!             v(k,ind)=monomial(Nodes(1,k),Nodes(2,k),i,j)
             v(k,ind)=jacobiTriangle(Nodes(1,k),Nodes(2,k),N,i,j)
          end do
       end do
    end do

    call ludcmp(v,M,pivot,d,code)
    
    do i=1,M
       v_inv(:,i)=0
       v_inv(i,i)=1
    end do

    do i=1,M
       call lubksb(v,M,pivot,v_inv(:,i))
    end do
          
    
  end subroutine
  

  function lgl_nodalBasis(x,y,N,a,b) result(z)
    integer :: N,M,i,j
    integer :: a,b,ind
    real(kind=GRID_SR) :: x,y,z
    real(kind=GRID_SR) :: values((N+1)*(N+2)/2)

    M=(N+1)*(N+2)/2

    do j=0,N
       do i=0,N-j
          ind=(i+1)+M-((N-j+1))*((N-j+2))/2
!          values(ind)=monomial(x,y,i,j)
          values(ind)=jacobiTriangle(x,y,N,i,j)
       end do
    end do

    ind=(a+1)+M-((N-b+1))*((N-b+2))/2
    z=dot_product(v_inv(ind,:),values)
    
  end function lgl_nodalBasis


    function equ_nodalBasis(x,y,N,a,b) result(z)
    integer :: N,M,i,j
    integer :: a,b,ind
    real(kind=GRID_SR) :: x,y,z
    real(kind=GRID_SR) :: values((N+1)*(N+2)/2)

    M=(N+1)*(N+2)/2

    do j=0,N
       do i=0,N-j
          ind=(i+1)+M-((N-j+1))*((N-j+2))/2
          values(ind)=monomial(x,y,i,j)
!          values(ind)=jacobiTriangle(x,y,N,i,j)
       end do
    end do

    ind=(a+1)+M-((N-b+1))*((N-b+2))/2
!    print*,"."
    z=dot_product(v_inv(:,ind),values)
    
  end function equ_nodalBasis

  function equ_nodal_basis_der_x(x,y,N,a,b) result(z)
    integer :: N,M,i,j
    integer :: a,b,ind
    real(kind=GRID_SR) :: x,y,z
    real(kind=GRID_SR) :: values((N+1)*(N+2)/2)

    M=(N+1)*(N+2)/2

    do j=0,N
       do i=0,N-j
          ind=(i+1)+M-((N-j+1))*((N-j+2))/2
          values(ind)=monomial_der_x(x,y,i,j)
       end do
    end do

    ind=(a+1)+M-((N-b+1))*((N-b+2))/2
    z=dot_product(v_inv(:,ind),values)
    
  end function equ_nodal_basis_der_x

  function equ_nodal_basis_der_y(x,y,N,a,b) result(z)
    integer :: N,M,i,j
    integer :: a,b,ind
    real(kind=GRID_SR) :: x,y,z
    real(kind=GRID_SR) :: values((N+1)*(N+2)/2)

    M=(N+1)*(N+2)/2

    do j=0,N
       do i=0,N-j
          ind=(i+1)+M-((N-j+1))*((N-j+2))/2
          values(ind)=monomial_der_y(x,y,i,j)
       end do
    end do

    ind=(a+1)+M-((N-b+1))*((N-b+2))/2
    z=dot_product(v_inv(:,ind),values)
    
  end function equ_nodal_basis_der_y

  


  subroutine get_lgl_nodes(nodes,N) 
    integer::N
    real(kind=GRID_SR), allocatable :: nodes(:,:)


    
    select case(N)
    case(2)
       allocate(nodes(2,4))
       nodes=reshape((/&
            0.16666666666666665741,0.16666666666666665741,&
            0.66666666666666662966,0.16666666666666665741,&
            0.16666666666666665741,0.66666666666666662966,&
            0.33333333333333331483,0.33333333333333331483/)&
            ,(/ 2, 4/))

    case(3)
       allocate(nodes(2,16))
       nodes=reshape((/&
            0.08333333333333332871, 0.08333333333333332871,&
            0.33333333333333331483, 0.08333333333333332871,&
            0.08333333333333332871, 0.33333333333333331483,&
            0.16666666666666665741, 0.16666666666666665741,&
            0.58333333333333337034, 0.08333333333333332871,&
            0.83333333333333337034, 0.08333333333333332871,&
            0.58333333333333337034, 0.33333333333333331483,&
            0.66666666666666662966, 0.16666666666666665741,&
            0.08333333333333332871, 0.58333333333333337034,&
            0.33333333333333331483, 0.58333333333333337034,&
            0.08333333333333332871, 0.83333333333333337034,&
            0.16666666666666665741, 0.66666666666666662966,&
            0.41666666666666668517, 0.41666666666666668517,&
            0.16666666666666665741, 0.41666666666666668517,&
            0.41666666666666668517, 0.16666666666666665741,&
            0.33333333333333331483, 0.33333333333333331483&
            /),(/ 2, 16 /))

    case(4)
       allocate(nodes(2,16))
       nodes=reshape((/&
            0.08333333333333332871,0.08333333333333332871,&
            0.33333333333333331483,0.08333333333333332871,&
            0.08333333333333332871,0.33333333333333331483,&
            0.16666666666666665741,0.16666666666666665741,&
            0.58333333333333337034,0.08333333333333332871,&
            0.83333333333333337034,0.08333333333333332871,&
            0.58333333333333337034,0.33333333333333331483,&
            0.66666666666666662966,0.16666666666666665741,&
            0.08333333333333332871,0.58333333333333337034,&
            0.33333333333333331483,0.58333333333333337034,&
            0.08333333333333332871,0.83333333333333337034,&
            0.16666666666666665741,0.66666666666666662966,&
            0.41666666666666668517,0.41666666666666668517,&
            0.16666666666666665741,0.41666666666666668517,&
            0.41666666666666668517,0.16666666666666665741,&
            0.33333333333333331483,0.33333333333333331483/),(/2,16 /))


    case(5)
       allocate(nodes(2,16))
       nodes=reshape((/&
            0.08333333333333332871,0.08333333333333332871,&
            0.33333333333333331483,0.08333333333333332871,&
            0.08333333333333332871,0.33333333333333331483,&
            0.16666666666666665741,0.16666666666666665741,&
            0.58333333333333337034,0.08333333333333332871,&
            0.83333333333333337034,0.08333333333333332871,&
            0.58333333333333337034,0.33333333333333331483,&
            0.66666666666666662966,0.16666666666666665741,&
            0.08333333333333332871,0.58333333333333337034,&
            0.33333333333333331483,0.58333333333333337034,&
            0.08333333333333332871,0.83333333333333337034,&
            0.16666666666666665741,0.66666666666666662966,&
            0.41666666666666668517,0.41666666666666668517,&
            0.16666666666666665741,0.41666666666666668517,&
            0.41666666666666668517,0.16666666666666665741,&
            0.33333333333333331483,0.33333333333333331483&
       /),(/ 2, 16/))

    case(6)
       allocate(nodes(2,64))
       nodes=reshape((/&
            0.04166666666666666435,0.04166666666666666435,&
            0.16666666666666665741,0.04166666666666666435,&
            0.04166666666666666435,0.16666666666666665741,&
            0.08333333333333332871,0.08333333333333332871,&
            0.29166666666666668517,0.04166666666666666435,&
            0.41666666666666668517,0.04166666666666666435,&
            0.29166666666666668517,0.16666666666666665741,&
            0.33333333333333331483,0.08333333333333332871,&
            0.04166666666666666435,0.29166666666666668517,&
            0.16666666666666665741,0.29166666666666668517,&
            0.04166666666666666435,0.41666666666666668517,&
            0.08333333333333332871,0.33333333333333331483,&
            0.20833333333333334259,0.20833333333333334259,&
            0.08333333333333332871,0.20833333333333334259,&
            0.20833333333333334259,0.08333333333333332871,&
            0.16666666666666665741,0.16666666666666665741,&
            0.54166666666666662966,0.04166666666666666435,&
            0.66666666666666662966,0.04166666666666666435,&
            0.54166666666666662966,0.16666666666666665741,&
            0.58333333333333337034,0.08333333333333332871,&
            0.79166666666666662966,0.04166666666666666435,&
            0.91666666666666662966,0.04166666666666666435,&
            0.79166666666666662966,0.16666666666666665741,&
            0.83333333333333337034,0.08333333333333332871,&
            0.54166666666666662966,0.29166666666666668517,&
            0.66666666666666662966,0.29166666666666668517,&
            0.54166666666666662966,0.41666666666666668517,&
            0.58333333333333337034,0.33333333333333331483,&
            0.70833333333333337034,0.20833333333333334259,&
            0.58333333333333337034,0.20833333333333334259,&
            0.70833333333333337034,0.08333333333333332871,&
            0.66666666666666662966,0.16666666666666665741,&
            0.04166666666666666435,0.54166666666666662966,&
            0.16666666666666665741,0.54166666666666662966,&
            0.04166666666666666435,0.66666666666666662966,&
            0.08333333333333332871,0.58333333333333337034,&
            0.29166666666666668517,0.54166666666666662966,&
            0.41666666666666668517,0.54166666666666662966,&
            0.29166666666666668517,0.66666666666666662966,&
            0.33333333333333331483,0.58333333333333337034,&
            0.04166666666666666435,0.79166666666666662966,&
            0.16666666666666665741,0.79166666666666662966,&
            0.04166666666666666435,0.91666666666666662966,&
            0.08333333333333332871,0.83333333333333337034,&
            0.20833333333333334259,0.70833333333333337034,&
            0.08333333333333332871,0.70833333333333337034,&
            0.20833333333333334259,0.58333333333333337034,&
            0.16666666666666665741,0.66666666666666662966,&
            0.45833333333333331483,0.45833333333333331483,&
            0.33333333333333331483,0.45833333333333331483,&
            0.45833333333333331483,0.33333333333333331483,&
            0.41666666666666668517,0.41666666666666668517,&
            0.20833333333333334259,0.45833333333333331483,&
            0.08333333333333332871,0.45833333333333331483,&
            0.20833333333333334259,0.33333333333333331483,&
            0.16666666666666665741,0.41666666666666668517,&
            0.45833333333333331483,0.20833333333333334259,&
            0.33333333333333331483,0.20833333333333334259,&
            0.45833333333333331483,0.08333333333333332871,&
            0.41666666666666668517,0.16666666666666665741,&
            0.29166666666666668517,0.29166666666666668517,&
            0.41666666666666668517,0.29166666666666668517,&
            0.29166666666666668517,0.41666666666666668517,&
            0.33333333333333331483,0.33333333333333331483 /),(/ 2, 64/))

    case(7)
       allocate(nodes(2,64))
       nodes= reshape((/&
            0.04166666666666666435,0.04166666666666666435,&
            0.16666666666666665741,0.04166666666666666435,&
            0.04166666666666666435,0.16666666666666665741,&
            0.08333333333333332871,0.08333333333333332871,&
            0.29166666666666668517,0.04166666666666666435,&
            0.41666666666666668517,0.04166666666666666435,&
            0.29166666666666668517,0.16666666666666665741,&
            0.33333333333333331483,0.08333333333333332871,&
            0.04166666666666666435,0.29166666666666668517,&
            0.16666666666666665741,0.29166666666666668517,&
            0.04166666666666666435,0.41666666666666668517,&
            0.08333333333333332871,0.33333333333333331483,&
            0.20833333333333334259,0.20833333333333334259,&
            0.08333333333333332871,0.20833333333333334259,&
            0.20833333333333334259,0.08333333333333332871,&
            0.16666666666666665741,0.16666666666666665741,&
            0.54166666666666662966,0.04166666666666666435,&
            0.66666666666666662966,0.04166666666666666435,&
            0.54166666666666662966,0.16666666666666665741,&
            0.58333333333333337034,0.08333333333333332871,&
            0.79166666666666662966,0.04166666666666666435,&
            0.91666666666666662966,0.04166666666666666435,&
            0.79166666666666662966,0.16666666666666665741,&
            0.83333333333333337034,0.08333333333333332871,&
            0.54166666666666662966,0.29166666666666668517,&
            0.66666666666666662966,0.29166666666666668517,&
            0.54166666666666662966,0.41666666666666668517,&
            0.58333333333333337034,0.33333333333333331483,&
            0.70833333333333337034,0.20833333333333334259,&
            0.58333333333333337034,0.20833333333333334259,&
            0.70833333333333337034,0.08333333333333332871,&
            0.66666666666666662966,0.16666666666666665741,&
            0.04166666666666666435,0.54166666666666662966,&
            0.16666666666666665741,0.54166666666666662966,&
            0.04166666666666666435,0.66666666666666662966,&
            0.08333333333333332871,0.58333333333333337034,&
            0.29166666666666668517,0.54166666666666662966,&
            0.41666666666666668517,0.54166666666666662966,&
            0.29166666666666668517,0.66666666666666662966,&
            0.33333333333333331483,0.58333333333333337034,&
            0.04166666666666666435,0.79166666666666662966,&
            0.16666666666666665741,0.79166666666666662966,&
            0.04166666666666666435,0.91666666666666662966,&
            0.08333333333333332871,0.83333333333333337034,&
            0.20833333333333334259,0.70833333333333337034,&
            0.08333333333333332871,0.70833333333333337034,&
            0.20833333333333334259,0.58333333333333337034,&
            0.16666666666666665741,0.66666666666666662966,&
            0.45833333333333331483,0.45833333333333331483,&
            0.33333333333333331483,0.45833333333333331483,&
            0.45833333333333331483,0.33333333333333331483,&
            0.41666666666666668517,0.41666666666666668517,&
            0.20833333333333334259,0.45833333333333331483,&
            0.08333333333333332871,0.45833333333333331483,&
            0.20833333333333334259,0.33333333333333331483,&
            0.16666666666666665741,0.41666666666666668517,&
            0.45833333333333331483,0.20833333333333334259,&
            0.33333333333333331483,0.20833333333333334259,&
            0.45833333333333331483,0.08333333333333332871,&
            0.41666666666666668517,0.16666666666666665741,&
            0.29166666666666668517,0.29166666666666668517,&
            0.41666666666666668517,0.29166666666666668517,&
            0.29166666666666668517,0.41666666666666668517,&
            0.33333333333333331483,0.33333333333333331483/),(/ 2, 64 /))
    end select
  end subroutine get_lgl_nodes
  
END MODULE dubiner
